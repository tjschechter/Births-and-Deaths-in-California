---
title: "California Births and Deaths, 1960 - 2023"
author: "Thomas Schechter"
date: "`r Sys.Date()`"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, warning = FALSE)

library(tidyverse)
library(data.table)

```

## Data - Births

This section is an exploratory look at our birth data from 1960 through 2023.

```{r}

# read in our data on births
births <- read_csv("data/20241030_births_final_state_month_sup.csv")

# subset to remove those unnecessary and NA cols
births <- births[,c(1:6)]

```

```{r}

# let's summarize - just how many births occurred in CA from 1960 -2023?

births_oc <- births %>% filter(Geography_Type == "Occurrence")

# how many births occurred per month? per year?

# use groupby() to group and sum

# months

births_oc_m <- births_oc %>% group_by(Month) %>%
  summarise(
    "Total Births" = sum(Count)
  )

# rename the months s.t. they have the month names instead of ordered #s

births_oc_m <- births_oc_m %>% mutate(
  Month = case_when(
    Month == "01" ~ "January",
    Month == "02" ~ "February",
    Month == "03" ~ "March",
    Month == "04" ~ "April",
    Month == "05" ~ "May",
    Month == "06" ~ "June",
    Month == "07" ~ "July",
    Month == "08" ~ "August",
    Month == "09" ~ "September",
    Month == "10" ~ "October",
    Month == "11" ~ "November",
    Month == "12" ~ "December"
  )
)

# use kable packages to create neat, readable tables

#install.packages("kableExtra")
library(kableExtra)

births_oc_m %>%
  kable(caption = "Births by Month in CA, 1960 - 2023") %>%
  kable_styling(full_width = FALSE,
                position = "center",
                latex_options = c("striped", "hold_position"))


```

```{r}

# let's compare residence births vs. occurrence births
# filter s.t we don't get the more granular views after 2018

births_m <- births %>% filter(Geography_Type == "Residence" | Geography_Type == "Occurrence") %>%
  group_by(Month, Geography_Type) %>%
  summarise(
    "Total Births" = sum(Count)
  )

# And now create a similar table for the comparison
births_m %>%
  kable(caption = "Births by Month in CA, 1960 - 2023") %>%
  kable_styling(full_width = FALSE,
                position = "center",
                latex_options = c("striped", "hold_position"))

```

There are fairly similar numbers, with a few thousand typically the difference. This tells us that either:
* California residents are giving birth out-of-state
* Non-residents of California are giving birth in California!

Next, we can check the distribution or spread of birth counts by month across the years.

```{r}
births_c <- births %>% filter(Strata == "Total Population") %>%
  mutate(Month = case_when(
    Month == "01" ~ "January",
    Month == "02" ~ "February",
    Month == "03" ~ "March",
    Month == "04" ~ "April",
    Month == "05" ~ "May",
    Month == "06" ~ "June",
    Month == "07" ~ "July",
    Month == "08" ~ "August",
    Month == "09" ~ "September",
    Month == "10" ~ "October",
    Month == "11" ~ "November",
    Month == "12" ~ "December"))

births_c %>%
  ggplot(aes(x = fct_relevel(
    Month,
    "January", "February", "March", "April",
    "May", "June", "July", "August",
    "September", "October", "November", "December"), y = Count)) +
  geom_boxplot() +
  ggtitle("Distribution of All Births in CA, by Month, 1960 - 2023")+
  ylab("Total Births") +
  xlab("")+
  theme_bw() +
  theme(axis.text.x = element_text(angle = 45, vjust = 0.5))

```

August seems to consistently have higher number of births, while February sees a lower number of births.

```{r}

# create a variable to indicate the date as month and year

#install.packages("zoo")

library(zoo) # library with as.yearmon() function

# Create a date variable - assume the first of the month only for functionality purposes
# the data is stratified by month
births_c <- births_c %>%
  mutate(Date = case_when(
    Month == "January" ~ paste(Year, "01-01", sep = "-"),
    Month == "February" ~ paste(Year, "02-01", sep = "-"),
    Month == "March" ~ paste(Year, "03-01", sep = "-"),
    Month == "April" ~ paste(Year, "04-01", sep = "-"),
    Month == "May" ~ paste(Year, "05-01", sep = "-"),
    Month == "June" ~ paste(Year, "06-01", sep = "-"),
    Month == "July" ~ paste(Year, "07-01", sep = "-"),
    Month == "August" ~ paste(Year, "08-01", sep = "-"),
    Month == "September" ~ paste(Year, "09-01", sep = "-"),
    Month == "October" ~ paste(Year, "10-01", sep = "-"),
    Month == "November" ~ paste(Year, "11-01", sep = "-"),
    Month == "December" ~ paste(Year, "12-01", sep = "-"),
  ) %>% as.Date()) 

# use zoo package's as.yearmon() fxn to convert into a format we want
births_c <- births_c %>% mutate(YearMonth = as.yearmon(Date))

# create a line chart to display behavior of "Occurrence" births in california
births_c %>% filter(Geography_Type == "Occurrence") %>% 
  ggplot(aes(x = YearMonth, y = Count)) +
  geom_line() +
  theme_bw() +
  ggtitle("Occurrence births in CA from 1960 - 2023, by month") +
  xlab("") +
  ylab("Births that occurred in CA")

```
There appears to be seasonality in births across the state of California. Let's add the residence strata of "Geography Type" too this chart:

```{r}

```

